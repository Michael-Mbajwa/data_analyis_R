---
title: "My answers"
author: "Michael Mbajwa"
date: "2021-11-19"
output: html_document
---


> This practical aims at performing exploratory plots and how-to build layer by layer to be familiar with
the grammar of graphics.  

##### Those kind of questions are optional {.bonus}


# Scatter plots of penguins

The `penguins` dataset is provided by the `palmerpenguins` R package. As for every function, most data-sets shipped with a package contain also a useful help page (`?`).

##### If not done already, install the package `palmerpenguins` and load it.

```{r}
# Write your answer here
library(palmerpenguins)
library(tidyverse)
library(ggplot2)
```

```{r}
# Write your answer here
penguins
```


##### Plot the body mass on the _y_ axis and the bill length on the _x_ axis.

```{r}
# Write your answer here
penguins %>%
  ggplot(aes(x=bill_length_mm,
             y=body_mass_g)) +
  geom_point(aplha=0.7) +
  labs(x = 'Bill length (mm)',
       y = 'Body mass (g)')
```


##### Plot again the body mass on the _y_ axis and the bill length on the _x_ axis, but with colour by `species`

```{r}
# Write your answer here
penguins %>%
  ggplot(aes(x=bill_length_mm,
             y=body_mass_g,
             color=species)) +
  geom_point(aplha=0.7) +
  labs(x='length (mm)',
       y='mass (g)')
```




##### The `geom_smooth()` layer can be used to add a trend line. Try to overlay it to your scatter plot.

```{block, opts.label = "tip"}
by default `geom_smooth` is using a loess regression (< 1,000 points) and adds standard error intervals. 

- The `method` argument can be used to change the regression to a linear one: `method = "lm"`
- to disable the ribbon of standard errors, set `se = FALSE`

Be careful where the aesthetics are located, so the trend linear lines are **also** colored per species.
```

```{r}
# Write your answer here
penguins %>%
  ggplot(aes(x = bill_length_mm,
                 y = body_mass_g,
                 colour = species)) +
  geom_point() +
  geom_smooth(method = 'lm', formula = 'y ~ x', se = FALSE)
```



##### Adjust the aesthetics of point in order to

- the `shape` map to the originated `island`
- a fixed size of `3`
- a transparency of 40%

```{block,  opts.label = "tip"}
You should still have only 3 coloured linear trend lines. Otherwise check to which layer your are adding the aesthetic `shape`.
Remember that fixed parameters are to be defined outside `aes()`
```

```{r}
# Write your answer here
penguins %>%
  ggplot(aes(x = bill_length_mm,
                 y = body_mass_g,
                 colour = species,
                shape = island)) +
  geom_point(size=3, alpha=0.8) +
  geom_smooth(method = 'lm', formula = 'y ~ x', se = FALSE)
```


##### Ajust the colour aesthetic to the `ggplot()` call to propagate it to both point and regression line.
Try the scale colour viridis for discrete scale (`scale_colour_viridis_d()`). Try to change the default theme to `theme_bw()`

```{r}
# Write your answer here
penguins %>%
  ggplot(aes(x = bill_length_mm,
                 y = body_mass_g,
                 colour = species,
                shape = island)) +
  geom_point(size=3, alpha=0.6) +
  geom_smooth(method = 'lm', formula = 'y ~ x', se = FALSE) +
  scale_color_viridis_d() +
  theme_bw() 
```


##### Find a way to produce the following plot:


```{r}
# Write your answer here
penguins %>%
  ggplot(aes(x = bill_length_mm,
                 y = body_mass_g,
                 colour = species,
                shape = island)) +
  geom_point(size=3, alpha=0.7) +
  geom_smooth(method = 'lm', formula = 'y ~ x', se = FALSE) +
  scale_color_viridis_d() +
  theme_bw() +
  theme(plot.title = element_text(family="sans"),
        plot.caption = element_text(face = "italic", hjust = 1.5)) +
  labs(x = 'Bill length (mm)',
       y = 'Body mass (g)',
       title = "Penguin bill length and body mass",
       subtitle = 'Dimensions for male/female Adelie, Chinstrap and Gentoo Penguins
       at Palmer Station LTER',
       shape = 'island',
       color = 'Penguin species',
       caption = 'Horst AM, Hill AP, Gorman KB(2020)')
```


```{block,  opts.label = "tip"}
Remember that:

- all aesthetics defined in the `ggplot(aes())` command will be inherited by all following layers
- `aes()` of individual geoms are specific (and overwrite the global definition if present).
- `labs()` controls of plot annotations
- `theme()` allows to tweak the plot like `theme(plot.caption = element_text(face = "italic"))` to render in italic the caption
```

# Categorical data

We are going to use a dataset from the [TidyTuesday](https://github.com/rfordatascience/tidytuesday/) initiative. Several dataset about the theme **deforestation** on April 2021 were released, we will focus on the csv called `brazil_loss.csv`. The dataset columns are described in the linked [README](https://github.com/rfordatascience/tidytuesday/blob/master/data/2021/2021-04-06/readme.md) and the csv is directly available at this [url](https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-04-06/brazil_loss.csv)


##### Load the `brazil_loss.csv` file, remove the 2 first columns (`entity` and `code` since it is all Brazil) and assign the name `brazil_loss`

```{block, opts.label = "tip"}
Set the data type of `year` to `character()`
```

```{r}
# Write your answer here
url <- 'https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-04-06/brazil_loss.csv'
load_url = readr::read_csv(url)
brazil_loss <- load_url %>%
              select(!contains(c('entity', 'code')))
brazil_loss <- brazil_loss %>%
  mutate(year = as.character(year))

brazil_loss
```


##### Is this dataset tidy?

```{r}
# Write your answer here
# Yes
# Every column is a single variable
# Each row is an observation of yearly data
# All cells have single data
```


##### Pivot the deforestation reasons (columns `commercial_crops` to `small_scale_clearing`) to the long format. Values are areas in hectares (`area_ha` is a good column name). Save as `brazil_loss_long`

```{r}
# Write your answer here
brazil_loss %>%
  pivot_longer(commercial_crops:small_scale_clearing,
               names_to = "deforestation_reasons",
               values_to = "area_ha") -> brazil_loss_long
brazil_loss_long
```



##### Plot the deforestation areas per year as bars

```{block, opts.label = "tip"}
- `year` needs to be a categorical data. If you didn't read the data as character for this column, you can convert it with `factor()`
- `geom_col()` requires 2 aesthetics
    + `x` must be **categorical / discrete** (see first item)
    + `y` **must be continuous**
```

```{r}
# Write your answer here
brazil_loss_long %>%
  ggplot(aes(x=year,
             y=area_ha)) +
  geom_col(fill = "#f68060") + 
  theme_classic() + 
  labs(title = "Deforestation areas per year in Brazil",
       x = "Year",
       y = "Area per hectare",
       caption = "Data credit: TidyTuesday")

```


##### Same as the plot above but bar filled by the reasons for deforestation

```{r}
# Write your answer here
brazil_loss_long %>%
  ggplot(aes(x=year,
             y=area_ha, 
             fill = deforestation_reasons)) +
  geom_col() + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Deforestation areas per year in Brazil",
       x = "Year",
       y = "Area per hectare",
       caption = "Data credit: TidyTuesday",
       fill = "Reasons for\nDeforestation") +
  theme(plot.caption = element_text(face = "italic", hjust = 1.5))
```


Even if we have too many categories, we can appreciate the amount of `natural_disturbances` versus the reasons induced by humans.

##### Lump the reasons for deforestations, keeping only the top 5 reasons, lumping as "Other" the rest

```{block, opts.label = "tip"}
- The function `fct_lump()` is very useful for this operation. Be careful to weight the categories with the appropriate continuous variable.
- The legend of filled colours could be renamed and suppress if the title is explicit
```

```{r}
# Write your answer here
brazil_loss_long %>%
  ggplot(aes(x = year,
             y = area_ha,
             fill = fct_lump(deforestation_reasons, 5, w = area_ha) %>%
               fct_infreq())) +
  geom_col()+
  theme_classic()+
  labs(title = "Top 5 yearly causes of Deforestation in Brazil",
       fill = "Reasons for\nDeforestation",
       x = "Year",
       y = "Areas per heactare",
       caption = "Data credit: TidyTuesday") +
  theme(axis.text.x = element_text(angle = 90)) +
  theme(plot.caption = element_text(face = "italic", hjust = 1.5))
```


##### Optimize the previous plot by sorting the 5 main deforestation reasons
```{block, opts.label = "tip"}
Unfortunately, `fct_infreq()` does not have a weight argument yet. 
You need then to take care of this manually.

One solution would be extract the top 5 main reasons using `dplyr` statements.

Then use this vector to recode the `reasons` with the reason name when part of the top5 or `other` if not. Then `fct_reorder(reasons2, area_ha)` does the correct reordering. You might want to use
`fct_rev()` to have the sorting from top to bottom in the legend.
```

```{r}
##### Optimize the previous plot by sorting the 5 main deforestation reasons
# Write your answer here
brazil_loss_long %>%
  group_by(year) %>%
  top_n(5, area_ha) %>%
  mutate(reasons2 = deforestation_reasons) -> top_5

brazil_loss_long %>%
  group_by(year) %>%
  left_join(top_5, by = c("year", "deforestation_reasons", "area_ha")) %>%
  replace_na(list(reasons2 = "Other")) %>%
  arrange(desc(area_ha), .by_group = TRUE) %>%
   ggplot(aes(x = year,
             y = area_ha,
             fill = fct_reorder(reasons2, area_ha, .desc = TRUE) %>%
               fct_rev())) +
  geom_col() +
  labs(title = "Top 5 yearly causes of Deforestation in Brazil",
       fill = "Reasons for\nDeforestation",
       x = "Year",
       y = "Areas per heactare",
       caption = "Data credit: TidyTuesday") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90))+
  theme(plot.caption = element_text(face = "italic", hjust = 2.0))
```


